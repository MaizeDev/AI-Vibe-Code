<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文本结构化解析工具 v5.0（自定义字段 & 追加模式）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body{font-family:system-ui,sans-serif}textarea{font-family:monospace}</style>
</head>
<body class="bg-gray-50 py-8">
    <div class="max-w-5xl mx-auto px-6">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-violet-600 to-indigo-600 text-white p-8">
                <h1 class="text-3xl font-bold">多记录文本结构化解析引擎 v5.0</h1>
                <p class="mt-2 opacity-90">支持自定义字段 · 支持追加数据 · 纯JS本地运行</p>
            </div>

            <div class="p-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 lg:gap-8">
                    
                    <!-- Left Column: Inputs -->
                    <div class="lg:pr-8">
                        <div class="mb-8">
                            <h2 class="text-lg font-semibold mb-4 text-gray-800">1. 配置输出字段</h2>
                            <div id="fields" class="flex flex-wrap gap-4 mb-4"></div>
                            <div class="flex gap-4">
                                <input type="text" id="newFieldInput" placeholder="输入新字段名..." class="flex-1 p-3 border border-gray-300 rounded-2xl focus:outline-none focus:border-violet-500 text-sm">
                                <button onclick="addNewField()" class="px-6 bg-gray-100 hover:bg-gray-200 rounded-2xl font-medium transition text-sm">添加字段</button>
                            </div>
                        </div>

                        <div class="mb-8">
                            <h2 class="text-lg font-semibold mb-4 text-gray-800">2. 输入原始文本</h2>
                            <textarea id="inputText" rows="12" class="w-full p-6 border border-gray-300 rounded-3xl focus:outline-none focus:border-violet-500 text-sm resize-y" placeholder="粘贴任意格式文本..."></textarea>
                        </div>

                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                            <button onclick="parseAndAppend()" class="bg-violet-600 hover:bg-violet-700 text-white py-4 rounded-3xl font-medium transition">追加到表格</button>
                            <button onclick="loadTestData()" class="bg-gray-100 hover:bg-gray-200 py-4 rounded-3xl font-medium transition">加载测试数据</button>
                            <button onclick="clearTable()" class="bg-red-500 hover:bg-red-600 text-white py-4 rounded-3xl font-medium transition lg:col-start-3">清空全部</button>
                        </div>
                    </div>

                    <!-- Right Column: Table -->
                    <div id="resultArea">
                        <div class="overflow-x-auto">
                            <table id="resultTable" class="w-full text-sm border-collapse"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center text-gray-400 text-xs mt-8">v5.0 纯JS本地运行 · 零外部依赖 · 稳定可靠</div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let fieldsList = ["姓名", "年龄", "学历", "联系方式", "身份证号", "毕业院校"];
        let selectedFields = new Set(fieldsList);
        let allData = []; // Holds all parsed records

        // --- FIELD CONFIGURATION FOR PARSING ---
        // Using a Map for easy extension and ordered processing
        const fieldParsers = new Map([
            ["姓名", text => text.match(/姓名\s*[:：]?\s*([\u4e00-\u9fa5]{2,4})/i)],
            ["身份证号", text => text.match(/身份证号\s*[:：]?\s*(\d{17}[\dXx]|\d{18})/i) || text.match(/(\d{17}[\dXx]|\d{18})/)],
            ["联系方式", text => text.match(/联系方式\s*[:：]?\s*(1[3-9]\d{9})/i) || text.match(/\b(1[3-9]\d{9})\b/)],
            ["学历", text => text.match(/(本科|硕士|博士)/)],
            ["毕业院校", text => text.match(/([\u4e00-\u9fa5]{2,12}(?:大学|学院))/)],
            ["年龄", text => text.match(/\b(\d{1,3})\s*岁?\b/)]
        ]);

        // --- INITIALIZATION ---
        window.onload = () => {
            renderFields();
        };

        // --- UI & FIELD MANAGEMENT ---
        function renderFields() {
            const container = document.getElementById("fields");
            container.innerHTML = "";
            fieldsList.forEach(f => {
                const isChecked = selectedFields.has(f);
                const div = document.createElement("div");
                div.className = "flex items-center gap-3 bg-gray-50 px-5 py-3 rounded-2xl";
                div.innerHTML = `
                    <input type="checkbox" id="f_${f}" ${isChecked ? 'checked' : ''} onchange="toggleField('${f}', this.checked)" class="w-5 h-5 accent-violet-600">
                    <label for="f_${f}" class="font-medium cursor-pointer">${f}</label>
                `;
                container.appendChild(div);
            });
            renderAll(); // Re-render table with potentially new field selection
        }

        function toggleField(field, checked) {
            checked ? selectedFields.add(field) : selectedFields.delete(field);
            renderAll(); // Update the table display
        }

        function addNewField() {
            const input = document.getElementById("newFieldInput");
            const newField = input.value.trim();
            if (newField && !fieldsList.includes(newField)) {
                fieldsList.push(newField);
                selectedFields.add(newField);
                // Add a generic parser for the new field. It will look for "fieldName: value"
                fieldParsers.set(newField, text => {
                    const regex = new RegExp(`${newField}\\s*[:：]?\\s*([^\\n\\r]+)`);
                    return text.match(regex);
                });
                renderFields();
                input.value = "";
            } else {
                alert("字段名不能为空或已存在。");
            }
        }
        
        // --- PARSING & DATA HANDLING ---
        function parseAndAppend() {
            try {
                const text = document.getElementById("inputText").value.trim();
                if (!text) return alert("请输入文本内容");
                
                const newData = parseText(text);
                if (newData.length > 0) {
                    allData.push(...newData);
                    document.getElementById("inputText").value = ""; // Clear input after successful parse
                }
                
                renderAll();
                document.getElementById("resultArea").scrollIntoView({ behavior: 'smooth' });

            } catch (e) {
                console.error(e);
                alert("解析出错：" + e.message + "\n\n请截图反馈，我将立即修复。");
            }
        }

        function parseText(text) {
            if (!text.trim()) return [];
            // Split the text before each occurrence of "姓名", which likely indicates a new record.
            // The positive lookahead `(?=...)` keeps the delimiter in the next split part.
            const recordsText = text.split(/(?=姓名\s*[:：]?)/i).filter(Boolean);
            return recordsText.map(t => parseSingleRecord(t.trim()));
        }

        function parseSingleRecord(text) {
            const record = {};
            // Initialize all possible fields to null
            fieldsList.forEach(f => record[f] = null);
            
            // Go through parsers
            for (let [field, parser] of fieldParsers.entries()) {
                const match = parser(text);
                if (match) {
                    // Use the last captured group, or the full match
                    const value = match[1] ? match[1].trim() : match[0].trim();
                    record[field] = (field === "身份证号") ? value.toUpperCase() : value;
                }
            }

            return record;
        }

        // --- RENDERING ---
        function renderAll() {
            renderTable();
        }

        function renderTable() {
            const table = document.getElementById("resultTable");
            table.innerHTML = ""; // Clear previous full render
            
            const visibleFields = fieldsList.filter(f => selectedFields.has(f));

            // Create Header
            let headHTML = "<thead><tr class='bg-gray-100'>";
            visibleFields.forEach(f => headHTML += `<th class="px-6 py-4 text-left font-medium text-gray-600">${f}</th>`);
            headHTML += "</tr></thead>";
            
            // Create Body
            let bodyHTML = "<tbody>";
            allData.forEach(row => {
                bodyHTML += "<tr class='border-t hover:bg-gray-50'>";
                visibleFields.forEach(f => {
                    const val = (row[f] !== null && row[f] !== undefined) ? `<span class="font-medium">${row[f]}</span>` : '<span class="text-gray-400">null</span>';
                    bodyHTML += `<td class="px-6 py-4">${val}</td>`;
                });
                bodyHTML += "</tr>";
            });
            bodyHTML += "</tbody>";

            table.innerHTML = headHTML + bodyHTML;
        }

        // --- UTILITY FUNCTIONS ---
        function clearTable() {
            if (confirm("确定要清空所有已解析的数据吗？")) {
                allData = [];
                renderAll();
            }
        }

        function loadTestData() {
            const testData = `姓名张三 身份证号132226111111113314 联系方式15011113477 毕业院校: 北京大学
姓名：李四 年龄：25岁 学历：硕士 联系方式：18622223333 毕业院校：清华大学 自定义字段: 这是个测试值
姓名: 王五, 年龄: 30, 学历: 博士, 联系方式: 13988887777, 身份证号: 440101199003078888, 毕业院校: 复旦大学`;
            document.getElementById("inputText").value = testData;
            parseAndAppend();
        }
    </script>
</body>
</html>