# MarkDownAppDemo 优化方案

- **日期**: 2026年01月27日
- **版本**: 第一次优化建议
- **方向**: 性能、安全、功能增强

---

## 摘要

本项目当前架构优秀，分层清晰，是进一步开发的坚实基础。本次优化建议主要围绕以下三个方向，旨在将项目从一个优秀的“原型”提升为一个更健壮、高性能且功能丰富的“产品”。

---

## 优化建议详情

### 1. 核心优化：C++ 模块的性能与安全 (方向: 后端核心)

**现状分析**:
当前 `MarkdownCore.cpp` 只是一个基础实现。自己编写一个完备、高效且安全的 Markdown 解析器非常复杂，容易引入性能和安全问题（如 XSS 跨站脚本攻击）。

**优化建议**:
集成一个经过业界考验的、高性能的 C/C++ Markdown 库，强烈推荐 **`cmark`**。

**优点**:
- **高性能**: `cmark` 是 CommonMark 规范的官方 C 语言参考实现，经过高度优化。
- **高安全性**: 能从源头上防止注入恶意的 HTML/JavaScript，比自行处理更可靠。
- **标准化**: 遵循 CommonMark 标准，确保渲染效果与 GitHub 等主流平台一致。

### 2. 编辑器优化：语法高亮的性能 (方向: 前端性能)

**现状分析**:
目前 `MacEditorView` 的高亮逻辑会在每次输入时重新解析整个文档，对于大文件会导致编辑器卡顿。

**优化建议**:
将“全量高亮”升级为 **“增量高亮”**。在 `textStorage(_:didProcessEditing:...)` 方法中，不处理整个文档 (`wholeRange`)，而是计算出本次编辑影响的**段落范围** (`string.paragraphRange(for: editedRange)`)，并只对该范围进行重新着色。

**核心代码思路**:
```swift
// In Coordinator class
func textStorage(_ textStorage: NSTextStorage, didProcessEditing editedMask: NSTextStorageEditActions, range editedRange: NSRange, changeInLength delta: Int) {
    guard editedMask.contains(.editedCharacters) else { return }
    let string = textStorage.string as NSString
    let highlightRange = string.paragraphRange(for: editedRange)
    // ... apply highlighting only within highlightRange
}
```
**效果**:
此项优化可将大文件场景下的编辑器响应速度提升数个量级。

### 3. 功能增强：滚动同步 (方向: 用户体验)

**现状分析**:
编辑长文档时，编辑器与预览窗口的滚动条互相独立，用户容易丢失上下文。

**优化建议**:
实现编辑器与预览窗口的**双向滚动同步**。

**实施步骤**:
1.  **注入元数据**: 在 C++ 核心生成 HTML 时，为每个块级元素（如 `<p>`, `<h1>`）添加 `data-source-line="[行号]"` 属性。
2.  **监听滚动**: 分别监听 `NSTextView` 和 `WKWebView` 的滚动事件。
3.  **同步位置**:
    - 编辑器滚动时，获取当前行号，通过 JavaScript 命令 `WKWebView` 滚动到对应的 `data-source-line` 元素。
    - 预览窗口滚动时，获取顶部元素的 `data-source-line`，回调给 Swift，命令 `NSTextView` 滚动到对应行。

### 4. 功能增强：提升应用完整性 (方向: 用户体验 & 功能)

**现状分析**:
应用目前功能较为基础，缺少标准桌面应用的一些便捷特性。

**优化建议**:
- **Markdown 工具栏**: 在编辑器上方增加一行按钮，用于快速插入粗体、斜体、列表、代码块等格式。
- **完整的文件 I/O**: 实现标准的 `File > Open...` 和 `File > Save` 功能，让应用能直接创建和编辑 `.md` 源文件，建议使用 `NSDocument` 架构。
- **状态栏**: 在窗口底部添加状态栏，实时显示**字数统计**、**行数**和光标位置等信息。
